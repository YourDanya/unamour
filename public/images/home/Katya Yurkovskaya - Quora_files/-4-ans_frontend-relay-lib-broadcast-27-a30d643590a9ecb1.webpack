(window.ansFrontendRelayWebpackJsonpFunction=window.ansFrontendRelayWebpackJsonpFunction||[]).push([["lib-broadcast"],{"4JlD":function(e,t,n){"use strict";var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,n,s){return t=t||"&",n=n||"=",null===e&&(e=undefined),"object"===typeof e?o(a(e),(function(a){var s=encodeURIComponent(r(a))+n;return i(e[a])?o(e[a],(function(e){return s+encodeURIComponent(r(e))})).join(t):s+encodeURIComponent(r(e[a]))})).join(t):s?encodeURIComponent(r(s))+n+encodeURIComponent(r(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var a=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},VHT1:function(e,t,n){"use strict";n.r(t),n.d(t,"getID",(function(){return w})),n.d(t,"setID",(function(){return S})),n.d(t,"processBroadcastData",(function(){return x})),n.d(t,"hashQueryHashWithVars",(function(){return j})),n.d(t,"hashFragmentHashWithVars",(function(){return D})),n.d(t,"Broadcast",(function(){return R})),n.d(t,"collectLiveCategories",(function(){return N}));var r=n("J4zp"),i=n.n(r),o=n("o0o1"),a=n.n(o),s=n("yXPU"),c=n.n(s),u=n("lwsE"),l=n.n(u),f=n("W8MJ"),d=n.n(f),h=n("SKAY"),p=n("8lmh"),y=n("Pp7N"),v=n("peAK"),b=n("mVMq"),k=n("ZXlt"),_=n("0xW3"),g=n("sEfC"),m=n.n(g),T=n("qy3/"),E=n("h39y");function O(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return q(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return q(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n["return"]||n["return"]()}finally{if(s)throw o}}}}function q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var w=function(){return R.id},S=function(e){R.id||(R.id=e)},x=function(e){var t=e.categoryToDepkeys,n=e.depkeyToVersion,r=e.dirtiedDepkeyToVersion;t&&y.c.dispatch({type:y.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,payload:{categoryToDepkeys:t}}),n&&y.c.dispatch({type:y.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:n,ignoreNewDepkey:!1}}),r&&y.c.dispatch({type:y.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:r,ignoreNewDepkey:!0}})},j=function(e){var t=e.queryHash,n=e.variables,r=Object(T.a)(n);return"".concat(t,":").concat(JSON.stringify(r,Object.keys(r).sort()))},D=function(e){var t=e.fragmentHash,n=e.variables,r=Object(T.a)(n);return"".concat(t,":").concat(JSON.stringify(r,Object.keys(r).sort()))},C=function(e){return e.split(":",3).join(":")},A=function(e){var t,n;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?null===(n=e)||void 0===n?void 0:n.fragment:e},Q=function(e){var t,n,r,i,o,a,s;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?e:"Fragment"!==(null===(n=e)||void 0===n?void 0:n.kind)?null:null===(r=e)||void 0===r||null===(i=r.metadata)||void 0===i||null===(o=i.reloadable)||void 0===o||null===(a=o.operation)||void 0===a||null===(s=a.queryOrNull)||void 0===s?void 0:s.call(a)},R=function(){function e(){var t=this;l()(this,e),this.depkeyToVersion=void 0,this.depkeyToCategories=void 0,this.queryHashToGqlQuery=void 0,this.categoryToGqlQueries=void 0,this.pendingGqlQueries=void 0,this.debounceExecutePendingGqlQueries=void 0,this.depkeyToVersion={},this.depkeyToCategories={},this.queryHashToGqlQuery={},this.categoryToGqlQueries={},this.pendingGqlQueries={},this.debounceExecutePendingGqlQueries=m()(c()(a.a.mark((function o(){var e;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return e=t.pendingGqlQueries,t.pendingGqlQueries={},n.next=4,t._executeGqlQueries(e);case 4:case"end":return n.stop()}}),o)}))),300);var n=Object(h.getSetting)("broadcastId"),r=Object(h.getSetting)("tchannelData");null===e.id&&n&&(e.id=n),r&&Object(k.start)(r),Object(k.setBeforeReconnectionFn)(this.refreshStaleDepkeys.bind(this)),Object(k.subscribe)("broadcastReloadDirtiedDepkeys",(function(e){if(e.dirtied_depkeys){var n,r={},o=O(e.dirtied_depkeys);try{for(o.s();!(n=o.n()).done;){var a=n.value,s=i()(a,2),c=s[0],u=s[1];r[c]=u}}catch(l){o.e(l)}finally{o.f()}t.processDepkeyToNewVersion(r)}})),y.c.subscribe(y.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,(function(e){var n;if(e&&"payload"in e){var r=(null!==(n=e.payload)&&void 0!==n?n:{}).categoryToDepkeys;r&&t.processCategoryToDepkeys(r)}})),y.c.subscribe(y.a.DEPKEYS_RECEIVED,(function(e){var n;if(e&&"payload"in e){var r=null!==(n=e.payload)&&void 0!==n?n:{},i=r.depkeyToVersion,o=r.ignoreNewDepkey,a=void 0!==o&&o;i&&t.updateDepkeyToNewVersion(i,a)}})),Object(_.b)("WEBNODE_BROADCAST_DIRTIED_DEPKEYS",(function(e){var n;if(e&&"payload"in e){var r=null===(n=e.payload)||void 0===n?void 0:n.dirtied_depkeys;if(r){var o,a={},s=O(r);try{for(s.s();!(o=s.n()).done;){var c=o.value,u=i()(c,2),l=u[0],f=u[1];a[l]=f}}catch(d){s.e(d)}finally{s.f()}t.processDepkeyToNewVersion(a,!1,!0)}}}))}return d()(e,[{key:"updateDepkeyToNewVersion",value:function(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];for(var n in e){var r=this.depkeyToVersion[n];if(r!==undefined||!t){var i=e[n];(r===undefined||i>r)&&(this.depkeyToVersion[n]=i)}}}},{key:"processDepkeyToNewVersion",value:function(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1],n=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(e){var r={};for(var i in e){var o=this.depkeyToVersion[i];if(o!==undefined||!n){var a=e[i];if(t||o===undefined||!(a<=o))for(var s in this.depkeyToVersion[i]=a,this.depkeyToCategories[i])for(var c in this.categoryToGqlQueries[s])if(!(c in r)){var u=this.categoryToGqlQueries[s][c];r[c]=u}}}this.executeGqlQueries(r)}}},{key:"processCategoryToDepkeys",value:function(e){if(0!==Object.keys(e).length)for(var t in e){var n,r=C(t),i=O(e[t]);try{for(i.s();!(n=i.n()).done;){var o=n.value;o in this.depkeyToCategories||(this.depkeyToCategories[o]={}),this.depkeyToCategories[o][r]=!0}}catch(a){i.e(a)}finally{i.f()}}}},{key:"_executeGqlQueries",value:function(){var e=c()(a.a.mark((function t(e){var n,r,i,o,s,c;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==Object.keys(e).length&&!Object(h.getSetting)("broadcastDisabled")){t.next=2;break}return t.abrupt("return");case 2:n=[],t.t0=a.a.keys(e);case 4:if((t.t1=t.t0()).done){t.next=15;break}if(r=t.t1.value,i=e[r],o=i.queryHash,s=i.variables,o){t.next=9;break}return t.abrupt("continue",4);case 9:if(c=this.queryHashToGqlQuery[o]){t.next=12;break}return t.abrupt("continue",4);case 12:n.push({query:c,variables:s}),t.next=4;break;case 15:return t.next=17,Promise.all(n.map((function(e){var t=e.query,n=e.variables;return Object(E.fetchQuery_DEPRECATED)(v["default"],t,n)})));case 17:case"end":return t.stop()}}),t,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"executeGqlQueries",value:function(){var e=c()(a.a.mark((function t(e){var n;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(n in e)n in this.pendingGqlQueries||(this.pendingGqlQueries[n]=e[n]);return t.next=3,this.debounceExecutePendingGqlQueries();case 3:case"end":return t.stop()}}),t,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refreshStaleDepkeys",value:function(){var t=c()(a.a.mark((function n(t){var r,i,o,s,c,u,l,f,d;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,Object(b.a)("/api/get_stale_deps_POST",{json:JSON.stringify({args:[],kwargs:{dependency_to_version:this.depkeyToVersion}})});case 3:i=n.sent,n.next=9;break;case 6:return n.prev=6,n.t0=n["catch"](0),n.abrupt("return");case 9:if(!Object(T.e)(null===(r=i)||void 0===r?void 0:r.value)){n.next=11;break}return n.abrupt("return");case 11:o=i.value,s=o.minSeq,c=o.broadcast_id,u=o.channelHash,l=o.netloc,f=o.targetUrl,d=o.depkeys,e.id=c,this.processDepkeyToNewVersion(d,!0),t({minSeq:s,channel:c,channelHash:u,boxName:l,targetUrl:f});case 15:case"end":return n.stop()}}),n,this,[[0,6]])})));return function(e){return t.apply(this,arguments)}}()},{key:"registerQuery",value:function(){var e=c()(a.a.mark((function t(e,n,r){var i,o,s,c,u,l,f=this;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=A(e),o=Q(e),i&&o&&r){t.next=4;break}return t.abrupt("return");case 4:return t.prev=4,s=o.hash,this.queryHashToGqlQuery[s]=o,c={queryHash:s,variables:n},t.next=10,j(c);case 10:u=t.sent,l=N(i.selections,r,{}),Object.keys(l).forEach((function(e){e in f.categoryToGqlQueries||(f.categoryToGqlQueries[e]={}),u in f.categoryToGqlQueries[e]||(f.categoryToGqlQueries[e][u]=c)})),t.next=18;break;case 15:t.prev=15,t.t0=t["catch"](4),Object(p.logJsError)("broadcast->registerQuery",t.t0,{originalError:t.t0});case 18:case"end":return t.stop()}}),t,this,[[4,15]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"deregisterQuery",value:function(){var e=c()(a.a.mark((function t(e,n){var r,i,o,s,c,u;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=Q(e)){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,i=r.hash,t.next=7,j({queryHash:i,variables:n});case 7:for(o=t.sent,s=0,c=Object.keys(this.categoryToGqlQueries);s<c.length;s++)u=c[s],o in this.categoryToGqlQueries[u]&&delete this.categoryToGqlQueries[u][o];t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](3),Object(p.logJsError)("broadcast->deregisterQuery",t.t0,{originalError:t.t0});case 14:case"end":return t.stop()}}),t,this,[[3,11]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();R.id=null;var N=function G(e,t,n){if(!t||"object"!==typeof t||t.constructor!==Object)return n;var r=t.id,i=t.__typename;return e.forEach((function(e){switch(e.kind){case"Condition":return void G(e.selections,t,n);case"ScalarField":case"LinkedField":var o=e.name,a=e.alias?e.alias:e.name,s=t[a];if("id"===o||"__typename"===o||null===s||s===undefined)return;if(e.selections)if(Array.isArray(s)){var c,u=O(s);try{for(u.s();!(c=u.n()).done;){var l=c.value;G(e.selections,l,n)}}catch(f){u.e(f)}finally{u.f()}}else G(e.selections,s,n);if(r===undefined||null===r||!i||!e.isLive)return;n["".concat(i,":").concat(o,":").concat(r)]=!0}})),n}},ZXlt:function(e,t,n){"use strict";n.r(t),n.d(t,"start",(function(){return b})),n.d(t,"stop",(function(){return k})),n.d(t,"setBeforeReconnectionFn",(function(){return _})),n.d(t,"subscribe",(function(){return g}));var r=n("lwsE"),i=n.n(r),o=n("W8MJ"),a=n.n(o),s=n("8lmh"),c=n("s4NR"),u=n.n(c),l=n("Tm8E"),f=n("0xW3");function d(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n["return"]||n["return"]()}finally{if(s)throw o}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var p,y=new l.a,v=null,b=function(e){null===v&&e&&!Object(f.d)()&&"WebSocket"in window&&(v=new E(e)).start()},k=function(){null!==v&&v.stop()},_=function(e){p=e},g=function(e,t){y.on("tchannel_message",(function(n,r){e===n&&r&&t(r)}))},m=function(e,t){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null,r="https:"===window.location.protocol?"wss:":"ws:";return n?r+"//"+n:[r,"//tch",Math.floor(1e6*Math.random())+1,".tch.",e,"/up/",t,"/updates?"].join("")},T=function(e){try{var t=JSON.parse(e),n=t.message_type,r=t.payload;if(!n||!r)return void Object(s.logJsError)("lib/tchannelClient:_processMessage","Malformed message data (missing message_type and/or payload): ".concat(e));y.trigger("tchannel_message",[n,r])}catch(i){Object(s.logJsError)("lib/tchannelClient:_processMessage","A message is not in JSON format: ".concat(e),{originalError:i})}},E=function(){function e(t){var n,r=this;i()(this,e),this._minSeq=void 0,this._channel=void 0,this._channelHash=void 0,this._boxName=void 0,this._baseHost=void 0,this._targetUrl=void 0,this._socket=void 0,this._isActive=void 0,this._backOffTime=void 0,this._maxBackOffTime=void 0,this._isConnected=void 0,this._minSeq=t.minSeq,this._channel=t.channel,this._channelHash=t.channelHash,this._boxName=t.boxName,this._baseHost=t.baseHost;var o=t.targetUrl;n=void 0===o?null:o,this._minSeq=this._minSeq?parseInt(this._minSeq):0,this._baseHost&&this._boxName&&(this._targetUrl=m(this._baseHost,this._boxName,n)),this._socket=null,this._isActive=!1,this._backOffTime=1e3,this._maxBackOffTime=3e4,window.addEventListener("online",(function(){r._connectWebSocket(!0)})),window.addEventListener("offline",(function(){r._isConnected=!1,r._closeWebSocket()}))}return a()(e,[{key:"start",value:function(){this._isActive=!0,this._connectWebSocket()}},{key:"stop",value:function(){this._isActive=!1}},{key:"_updateBackOffTime",value:function(){var e=arguments.length>0&&arguments[0]!==undefined&&arguments[0];e&&(this._backOffTime=500),this._backOffTime=Math.min(2*this._backOffTime,this._maxBackOffTime)}},{key:"_connectWebSocket",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==undefined&&arguments[0];setTimeout((function(){null===e._socket&&(t&&p?p(e._makeWebSocketRequest.bind(e)):e._makeWebSocketRequest())}),this._backOffTime)}},{key:"_closeWebSocket",value:function(){null!==this._socket&&(this._socket.close(1e3),this._socket=null)}},{key:"_makeWebSocketRequest",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},n=t.minSeq,r=t.channel,i=t.channelHash,o=t.boxName,a=t.targetUrl;this._minSeq=n!==undefined?parseInt(n):this._minSeq,this._channel=r||this._channel,this._channelHash=i||this._channelHash,this._boxName=o||this._boxName,this._boxName&&this._baseHost&&(this._targetUrl=m(this._baseHost,this._boxName,a));var s="".concat(this._targetUrl).concat(u.a.stringify({min_seq:this._minSeq,channel:this._channel,hash:this._channelHash}));try{this._socket=new window.WebSocket(s)}catch(c){return void this._onError()}this._socket.onclose=function(t){e._isConnected&&(e._isConnected=!1,e._connectWebSocket(!0))},this._socket.onerror=function(t){e._closeWebSocket(),e._onError()},this._socket.onmessage=function(t){e._onReceivedResponse(JSON.parse(t.data))}}},{key:"_onReceivedResponse",value:function(e){if(this._isActive){this._updateBackOffTime(!0),this._isConnected=!0;try{if(e.error)throw e.error;this._minSeq=parseInt(e.min_seq);var t,n=d(e.messages);try{for(n.s();!(t=n.n()).done;){var r=t.value;T(r)}}catch(i){n.e(i)}finally{n.f()}}catch(o){return}}}},{key:"_onError",value:function(){var e=this;setTimeout((function(){e._isActive&&e._updateBackOffTime()}),0)}}]),e}()},kd2E:function(e,t,n){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,n,o){t=t||"&",n=n||"=";var a={};if("string"!==typeof e||0===e.length)return a;var s=/\+/g;e=e.split(t);var c=1e3;o&&"number"===typeof o.maxKeys&&(c=o.maxKeys);var u=e.length;c>0&&u>c&&(u=c);for(var l=0;l<u;++l){var f,d,h,p,y=e[l].replace(s,"%20"),v=y.indexOf(n);v>=0?(f=y.substr(0,v),d=y.substr(v+1)):(f=y,d=""),h=decodeURIComponent(f),p=decodeURIComponent(d),r(a,h)?i(a[h])?a[h].push(p):a[h]=[a[h],p]:a[h]=p}return a};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},s4NR:function(e,t,n){"use strict";t.decode=t.parse=n("kd2E"),t.encode=t.stringify=n("4JlD")}}]);